#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

indent() {
  sed -u 's/^/       /'
}

# fail fast
set -e
# fail if pipe to indent fails
set -o pipefail

BUILDPACK_DIR=`cd $(dirname $0); cd ..; pwd`
BUILD_DIR=$1
CACHE_DIR=$2

# config
APACHE_VERSION="2.4.25"
APACHE_PATH="${BUILD_DIR}/httpd-${APACHE_VERSION}"
PHP_VERSION="5.6.29"
PHP_PATH="${BUILD_DIR}/php-${PHP_VERSION}"

SITE_DIR=$CACHE_DIR/site
OUTPUT_DIR=$CACHE_DIR/site/output
GEM_DIR=$CACHE_DIR/vendor/bundle
CONFIG_FILE=$SITE_DIR/nanoc.yaml

# fall back to old-style config.yaml
if [ ! -f $CONFIG_FILE ]; then
  CONFIG_FILE=$SITE_DIR/config.yaml
fi

# include .files when moving things around
shopt -s dotglob

cd $BUILD_DIR

# move site directory to site dir
rm -rf $SITE_DIR/*
mkdir -p $SITE_DIR
mv * $SITE_DIR

# put the Procfile back :)
if [ -f $SITE_DIR/Procfile ]; then
  mv $SITE_DIR/Procfile $BUILD_DIR
fi

# Sourced from https://github.com/micwallace/dokku-buildpack-apt-apache-php/blob/1c73a6b3095cc3fc6ce5591a7be00e848501512d/bin/compile

APACHE_URL="https://content.wallaceit.com.au/buildpackassets/apache-$APACHE_VERSION.tar.gz"
echo "-----> Bundling Apache version $APACHE_VERSION"
curl --silent --max-time 60 --location "$APACHE_URL" | tar xz
echo "-----> Apache version $APACHE_VERSION bundled"

PHP_URL="https://content.wallaceit.com.au/buildpackassets/php-$PHP_VERSION.tar.gz"
echo "-----> Bundling PHP version $PHP_VERSION"
curl --silent --max-time 60 --location "$PHP_URL" | tar xz
echo "-----> PHP version $PHP_VERSION bundled"

# copy config files
mkdir -p $APACHE_PATH/conf
cp $BUILDPACK_DIR/conf/httpd.conf $APACHE_PATH/conf
cp $BUILDPACK_DIR/conf/php.ini $PHP_PATH

# add a boot proc
cat >>boot.sh <<EOF
mkdir -p /app/$APACHE_PATH/logs
for var in \`env|cut -f1 -d=\`; do
  echo "PassEnv \$var" >> $APACHE_PATH/conf/httpd.conf;
done
touch $APACHE_PATH/logs/{error,access}_log
tail -F $APACHE_PATH/logs/{error,access}_log &
export LD_LIBRARY_PATH=$PHP_PATH/ext PHP_INI_SCAN_DIR=/app/output
echo "Launching apache"
exec $APACHE_PATH/bin/httpd -DNO_DETACH
EOF
chmod +x boot.sh


echo "-----> Installing nanoc"

export LANG=en_US.UTF-8
export GEM_HOME=$GEM_DIR
export PATH=$GEM_DIR/bin:$PATH

# set up gemrc
cat << EOF > ~/.gemrc
gem: --no-rdoc --no-ri
gemhome: $GEM_DIR
gempath:
- $GEM_DIR
EOF

# install bundler
/usr/bin/env gem install bundler > /dev/null

cd $SITE_DIR

INSTALLED_RUBY=$(ruby -e 'puts "#{RUBY_VERSION}"')
echo "Detected Ruby version ${INSTALLED_RUBY}, will ignore version specified in Gem or .ruby-version" | indent
echo "${INSTALLED_RUBY}" > .ruby-version
sed -i -e "s/^ruby .*/ruby \"${INSTALLED_RUBY}\"/g" Gemfile
sed -i -e "s/ruby .*/ruby ${INSTALLED_RUBY}/g" Gemfile.lock

# install nanoc
if [ ! -f $SITE_DIR/Gemfile ]; then
    echo "Gemfile not found" | indent
    exit 1
fi

export BUNDLE_GEMFILE=$SITE_DIR/Gemfile

$GEM_DIR/bin/bundle install --deployment --gemfile=$BUNDLE_GEMFILE --path=$GEM_DIR | indent

echo "-----> Compiling nanoc site"

# set up nanoc config
cat << EOF >> $CONFIG_FILE
output_dir: $OUTPUT_DIR
enable_output_diff: false
EOF

# go go gadget nanoc!
$GEM_DIR/bin/bundle exec nanoc compile | indent

# and copy it back
cp -r $OUTPUT_DIR $BUILD_DIR/output
